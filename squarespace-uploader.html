<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Uploader with OCR</title>
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@0.0.8/piexif.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #C99A2C 0%, #B8862A 100%);
      width: 100%;
      height: 100vh;
      padding: 20px;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
    }

    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
      font-size: 28px;
    }

    .upload-section {
      display: none;
    }

    .upload-section.active {
      display: block;
    }

    .dropzone {
      border: 3px dashed #C99A2C;
      border-radius: 8px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8f9ff;
    }

    .dropzone:hover {
      border-color: #B8862A;
      background: #fef4e7;
    }

    .dropzone.dragover {
      border-color: #B8862A;
      background: #fef4e7;
      transform: scale(1.02);
    }

    .dropzone-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .dropzone-text {
      color: #666;
      margin-bottom: 10px;
    }

    .dropzone-hint {
      color: #999;
      font-size: 14px;
    }

    #fileInput {
      display: none;
    }

    .preview-section {
      margin-top: 30px;
      display: none;
    }

    .preview-section.active {
      display: block;
      position: relative;
    }

    .preview-image {
      width: 100%;
      max-width: 300px;
      height: auto;
      border-radius: 8px;
      margin-bottom: 20px;
      margin-left: auto;
      margin-right: auto;
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      max-height: 150px;
      resize: vertical;
      background: #f8f9fa;
      color: #333;
    }

    textarea:focus {
      outline: none;
      border-color: #C99A2C;
      background: white;
      box-shadow: 0 0 0 3px rgba(201, 154, 44, 0.1);
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #C99A2C;
      box-shadow: 0 0 0 3px rgba(201, 154, 44, 0.1);
    }

    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
      background-color: white;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #C99A2C;
      box-shadow: 0 0 0 3px rgba(201, 154, 44, 0.1);
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }

    button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-upload {
      background: #C99A2C;
      color: #f8f8f8;
    }

    .btn-upload:hover:not(:disabled) {
      background-color: #444;
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .btn-upload:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-cancel {
      background: #e0e0e0;
      color: #333;
    }

    .btn-cancel:hover {
      background: #d0d0d0;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      background: transparent;
      border-radius: 8px;
      z-index: 1;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 15px;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #C99A2C;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .message {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }

    .message.active {
      display: block;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .hint-text {
      color: #666;
      font-size: 12px;
      margin-top: 6px;
      font-style: italic;
    }

    .file-info {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 12px;
      color: #666;
    }

    .queue-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      margin-bottom: 5px;
      font-size: 13px;
    }

    .queue-item.uploading {
      background: #fef4e7;
      border-color: #C99A2C;
    }

    .queue-item.uploaded {
      background: #d4edda;
      border-color: #28a745;
    }

    .queue-item.error {
      background: #f8d7da;
      border-color: #dc3545;
    }

    .queue-item-name {
      flex: 1;
      word-break: break-word;
      color: #333;
    }

    .queue-item-status {
      margin-left: 10px;
      font-size: 12px;
      font-weight: 600;
    }

    .file-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: #f8f9fa;
      display: grid;
      grid-template-columns: 100px 1fr auto;
      gap: 15px;
      align-items: start;
    }

    .file-card-preview {
      width: 100px;
      height: 100px;
      border-radius: 6px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid #ddd;
    }

    .file-card-preview img,
    .file-card-preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .file-card-preview-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      background: linear-gradient(135deg, #C99A2C 0%, #B8862A 100%);
      color: white;
    }

    .file-card-content {
      display: grid;
      gap: 12px;
    }

    .file-card-header {
      font-weight: 600;
      color: #333;
      display: flex;
      justify-content: space-between;
    }

    .file-card-header-right {
      font-size: 12px;
      color: #999;
      font-weight: 400;
    }

    .file-card-fields {
      display: grid;
      gap: 10px;
    }

    .file-card-field {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 10px;
      align-items: center;
    }

    .file-card-field label {
      margin: 0;
      font-size: 12px;
      text-transform: none;
      letter-spacing: 0;
      font-weight: 500;
      color: #666;
    }

    .file-card-field input,
    .file-card-field select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      margin: 0;
    }

    .file-card-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .btn-remove {
      background: #dc3545;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn-remove:hover {
      background: #c82333;
    }

    .btn-remove:disabled {
      background: #ddd;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Bulk Media Uploader</h1>

    <div id="message" class="message"></div>

    <!-- Upload Section -->
    <div id="uploadSection" class="upload-section active">
      <div class="dropzone" id="dropzone">
        <div class="dropzone-icon">üìÅ</div>
        <div class="dropzone-text">Drag and drop your files here</div>
        <div class="dropzone-hint">Images, videos, audio, and PDF documents supported</div>
      </div>
      <input type="file" id="fileInput" accept="image/*,video/*,audio/*,application/pdf" multiple>
    </div>

    <!-- Combined File Selection & Metadata Section -->
    <div id="combinedSection" class="preview-section">
      <div class="form-group">
        <label>Files to Upload (<span id="fileCount">0</span>)</label>
        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px;">
          <div id="filesList" style="display: grid; gap: 15px;">
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="batchFolderSelect">Default Media Library Folder</label>
        <select id="batchFolderSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; transition: border-color 0.3s;">
          <option value="">Loading folders...</option>
        </select>
        <div class="hint-text">Set a default folder for all files (can be overridden per file)</div>
      </div>

      <div class="form-group">
        <label for="batchTagsInput">Default Tags (Optional)</label>
        <input type="text" id="batchTagsInput" placeholder="e.g., Event 2024, Winter Collection, Project A" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        <div class="hint-text">Tags to apply to all files (can be overridden per file)</div>
      </div>

      <div class="button-group">
        <button class="btn-upload" id="uploadAllBtn">Upload All Files</button>
        <button class="btn-cancel" id="clearAllBtn">Clear Queue</button>
      </div>
    </div>

    <!-- Upload Progress Section -->
    <div id="progressSection" class="preview-section">
      <div style="margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #C99A2C 0%, #B8862A 100%); border-radius: 8px; color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <div>
            <div style="font-size: 14px; opacity: 0.9;">Upload Progress</div>
            <div style="font-size: 24px; font-weight: bold;">File <span id="uploadProgress">0</span> of <span id="uploadTotal">0</span></div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 14px; opacity: 0.9;">Videos Uploaded</div>
            <div style="font-size: 24px; font-weight: bold;" id="totalVideosUploaded">0</div>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
          <div id="uploadProgressBar" style="background: white; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px;">
          <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px;">
            <div style="font-size: 12px; opacity: 0.9;">Uploaded</div>
            <div style="font-size: 18px; font-weight: bold;" id="realtimeSuccess">0</div>
          </div>
          <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px;">
            <div style="font-size: 12px; opacity: 0.9;">Failed</div>
            <div style="font-size: 18px; font-weight: bold;" id="realtimeFailed">0</div>
          </div>
          <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px;">
            <div style="font-size: 12px; opacity: 0.9;">Skipped</div>
            <div style="font-size: 18px; font-weight: bold;" id="realtimeSkipped">0</div>
          </div>
        </div>
      </div>

      <div id="loading" class="loading" style="position: static; background: transparent; display: flex; justify-content: center; align-items: center; padding: 20px; gap: 15px; margin-bottom: 20px; display: none;">
        <div class="spinner"></div>
        <div id="loadingText" style="color: #333; font-weight: 500;">Processing file...</div>
      </div>

      <div id="currentFileStatus" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;">
        <strong>Currently uploading: <span id="currentFileName"></span></strong>
      </div>
    </div>

    <!-- Summary Section -->
    <div id="summarySection" class="preview-section">
      <div class="form-group">
        <label>Upload Summary</label>
        <div id="summaryContent" style="background: #f8f9fa; padding: 15px; border-radius: 6px; font-size: 14px; line-height: 1.6;">
        </div>
      </div>

      <div class="button-group">
        <button class="btn-upload" id="uploadMoreBtn">Upload More</button>
      </div>
    </div>
  </div>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const uploadSection = document.getElementById('uploadSection');
    const combinedSection = document.getElementById('combinedSection');
    const progressSection = document.getElementById('progressSection');
    const summarySection = document.getElementById('summarySection');
    const loading = document.getElementById('loading');
    
    const filesList = document.getElementById('filesList');
    const fileCount = document.getElementById('fileCount');
    const batchFolderSelect = document.getElementById('batchFolderSelect');
    const batchTagsInput = document.getElementById('batchTagsInput');
    const message = document.getElementById('message');
    const loadingText = document.getElementById('loadingText');
    const summaryContent = document.getElementById('summaryContent');
    const totalVideosUploaded = document.getElementById('totalVideosUploaded');

    const uploadAllBtn = document.getElementById('uploadAllBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const uploadMoreBtn = document.getElementById('uploadMoreBtn');

    let fileQueue = [];
    let uploadSummary = { success: 0, skipped: 0, failed: 0, errors: [], videosUploaded: 0 };

    // Determine API base URL based on environment
    const API_BASE_URL = window.location.hostname === 'localhost' 
      ? `${window.location.origin}`
      : `https://cloudinary-search.vercel.app`;

    // Get API key from URL parameter or global variable
    const urlParams = new URLSearchParams(window.location.search);
    const API_KEY = urlParams.get('key') || window.API_KEY || '';

    // Helper function to add API key to fetch requests
    function getApiHeaders(additionalHeaders = {}) {
      const headers = { ...additionalHeaders };
      if (API_KEY) {
        headers['x-api-key'] = API_KEY;
      }
      return headers;
    }

    // Version checking
    async function checkVersion() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/version`, {
          headers: getApiHeaders()
        });
        const versionData = await response.json();
        const storedVersion = localStorage.getItem('appVersion');
        const currentVersion = versionData.version;

        if (storedVersion && storedVersion !== currentVersion) {
          console.log(`Version update detected: ${storedVersion} ‚Üí ${currentVersion}. Reloading...`);
          localStorage.setItem('appVersion', currentVersion);
          // Reload with cache bust
          window.location.href = window.location.href.split('?')[0] + '?v=' + Date.now();
        } else if (!storedVersion) {
          localStorage.setItem('appVersion', currentVersion);
        }
      } catch (err) {
        console.warn('Could not check version:', err.message);
      }
    }

    // Check version on load
    checkVersion();

    // Fetch folders from API
    async function loadFolders() {
      try {
        const foldersUrl = `${API_BASE_URL}/api/folders?t=${Date.now()}`;
        console.log('Loading folders from:', foldersUrl);
        const response = await fetch(foldersUrl, {
          headers: getApiHeaders()
        });
        const data = await response.json();
        
        if (data.folders && Array.isArray(data.folders)) {
          const populateSelect = (selectElement) => {
            selectElement.innerHTML = '';
            
            const rootOption = document.createElement('option');
            rootOption.value = '';
            rootOption.textContent = 'üìÅ Root Folder';
            selectElement.appendChild(rootOption);
            
            data.folders.forEach(folderPath => {
              if (folderPath) {
                const option = document.createElement('option');
                option.value = folderPath;
                const displayName = folderPath.split('/').pop();
                option.textContent = displayName || folderPath;
                selectElement.appendChild(option);
              }
            });
          };
          
          populateSelect(batchFolderSelect);
          console.log(`Loaded ${data.folders.length} folders`);
        } else {
          console.warn('No folders in response:', data);
          batchFolderSelect.innerHTML = '<option value="">Root Folder</option>';
        }
      } catch (error) {
        console.error('Error loading folders:', error);
        batchFolderSelect.innerHTML = '<option value="">Root Folder (error loading)</option>';
      }
    }

    loadFolders();

    // Function to manually refresh folders (useful when new folders are added)
    window.refreshFolders = function() {
      console.log('Refreshing folders...');
      loadFolders();
    };

    // Dropzone listeners
    dropzone.addEventListener('click', () => fileInput.click());

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      addFilestoQueue(Array.from(files));
    });

    fileInput.addEventListener('change', (e) => {
      addFilestoQueue(Array.from(e.target.files));
    });

    function addFilestoQueue(files) {
      const validFiles = files.filter(f => {
        return f.type.startsWith('image/') || 
               f.type.startsWith('video/') || 
               f.type.startsWith('audio/') ||
               f.type === 'application/pdf';
      });
      
      if (validFiles.length === 0) {
        showMessage('Please select image, video, audio, or PDF files only', 'error');
        return;
      }

      fileQueue = validFiles.map(file => ({
        file,
        name: file.name.replace(/\.[^/.]+$/, ''),
        status: 'pending',
        type: file.type === 'application/pdf' ? 'pdf' : file.type.split('/')[0],
        mediaName: file.name.replace(/\.[^/.]+$/, ''),
        folder: '',
        tags: '',
        ocrText: ''
      }));

      renderFilesList();
      uploadSection.classList.remove('active');
      combinedSection.classList.add('active');
      fileInput.value = '';
    }

    function renderFilesList() {
      fileCount.textContent = fileQueue.length;
      filesList.innerHTML = fileQueue.map((item, idx) => `
        <div class="file-card" id="file-${idx}">
          <div class="file-card-preview">
            ${getPreviewElement(item, idx)}
          </div>
          <div class="file-card-content">
            <div class="file-card-header">
              <span>${item.file.name}</span>
              <span class="file-card-header-right">${(item.file.size / 1024).toFixed(2)} KB</span>
            </div>
            <div class="file-card-fields">
              <div class="file-card-field">
                <label>Name *</label>
                <input type="text" class="file-media-name" data-idx="${idx}" value="${item.mediaName}" placeholder="Media name">
              </div>
              <div class="file-card-field">
                <label>Folder</label>
                <select class="file-folder" data-idx="${idx}" value="${item.folder}">
                  <option value="">üìÅ Root</option>
                  ${getAllFolderOptions()}
                </select>
              </div>
              <div class="file-card-field">
                <label>Tags</label>
                <input type="text" class="file-tags" data-idx="${idx}" value="${item.tags}" placeholder="e.g., tag1, tag2">
              </div>
            </div>
          </div>
          <div class="file-card-actions">
            <button class="btn-remove" data-idx="${idx}">Remove</button>
          </div>
        </div>
      `).join('');

      // Add event listeners for file card inputs
      document.querySelectorAll('.file-media-name').forEach(input => {
        input.addEventListener('change', (e) => {
          const idx = e.target.dataset.idx;
          fileQueue[idx].mediaName = e.target.value;
        });
      });

      document.querySelectorAll('.file-folder').forEach(select => {
        select.addEventListener('change', (e) => {
          const idx = e.target.dataset.idx;
          fileQueue[idx].folder = e.target.value;
        });
      });

      document.querySelectorAll('.file-tags').forEach(input => {
        input.addEventListener('change', (e) => {
          const idx = e.target.dataset.idx;
          fileQueue[idx].tags = e.target.value;
        });
      });

      document.querySelectorAll('.btn-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = e.target.dataset.idx;
          fileQueue.splice(idx, 1);
          renderFilesList();
        });
      });

      // Load image previews only (video and audio use placeholder icons)
      fileQueue.forEach((item, idx) => {
        if (item.type === 'image') {
          const reader = new FileReader();
          reader.onload = (e) => {
            setTimeout(() => {
              const previewEl = document.getElementById(`preview-${idx}`);
              if (previewEl) {
                previewEl.src = e.target.result;
              }
            }, 100);
          };
          reader.readAsDataURL(item.file);
        }
      });
    }

    function getPreviewElement(item, idx) {
      const previewId = `preview-${idx}`;
      const file = item.file;
      
      if (item.type === 'image') {
        return `<img id="${previewId}" src="" alt="Preview">`;
      } else if (item.type === 'video') {
        return `<div class="file-card-preview-placeholder">üé•</div>`;
      } else if (item.type === 'audio') {
        return `<div class="file-card-preview-placeholder">üéµ</div>`;
      } else if (item.type === 'pdf') {
        return `<div class="file-card-preview-placeholder">üìÑ</div>`;
      }
      return `<div class="file-card-preview-placeholder">üìÅ</div>`;
    }

    function getAllFolderOptions() {
      const options = [];
      const folders = batchFolderSelect.querySelectorAll('option');
      folders.forEach(option => {
        if (option.value !== '') {
          options.push(`<option value="${option.value}">${option.textContent}</option>`);
        }
      });
      return options.join('');
    }

    clearAllBtn.addEventListener('click', () => {
      fileQueue = [];
      combinedSection.classList.remove('active');
      uploadSection.classList.add('active');
      resetMessage();
    });

    uploadAllBtn.addEventListener('click', async () => {
      // Validate all files have media names
      for (let i = 0; i < fileQueue.length; i++) {
        if (!fileQueue[i].mediaName.trim()) {
          showMessage(`File ${i + 1} requires a media name`, 'error');
          return;
        }
      }

      uploadSummary = { success: 0, skipped: 0, failed: 0, errors: [], videosUploaded: 0 };
      totalVideosUploaded.textContent = '0';
      document.getElementById('uploadTotal').textContent = fileQueue.length;
      
      // Initialize real-time counters
      document.getElementById('uploadProgress').textContent = '0';
      document.getElementById('realtimeSuccess').textContent = '0';
      document.getElementById('realtimeFailed').textContent = '0';
      document.getElementById('realtimeSkipped').textContent = '0';
      
      combinedSection.classList.remove('active');
      progressSection.classList.add('active');

      await uploadAllFiles();
    });

    async function uploadAllFiles() {
      for (let i = 0; i < fileQueue.length; i++) {
        await uploadFile(i);
      }

      progressSection.classList.remove('active');
      showUploadSummary();
    }

    async function uploadFile(idx) {
      const item = fileQueue[idx];
      
      try {
        document.getElementById('uploadProgress').textContent = idx + 1;
        document.getElementById('currentFileName').textContent = item.file.name;
        document.getElementById('currentFileStatus').style.display = 'block';
        loading.classList.add('active');

        const fileSizeMB = item.file.size / (1024 * 1024);
        let data;

        // For large files (>100MB), use direct upload to bypass serverless limits
        if (fileSizeMB > 100 && item.type !== 'image') {
          console.log(`File is ${fileSizeMB.toFixed(2)}MB - using direct upload`);
          data = await uploadDirectToCloudinary(item);
          if (!data.success) {
            throw new Error('Direct upload failed');
          }
        } else {
          // Use server upload for small files or images
          data = await uploadViaServer(item);
        }

        item.status = 'uploaded';
        uploadSummary.success++;
        if (item.type === 'video') {
          uploadSummary.videosUploaded++;
          totalVideosUploaded.textContent = uploadSummary.videosUploaded;
        }

        // Update real-time counters
        document.getElementById('realtimeSuccess').textContent = uploadSummary.success;

        // Update progress
        const progress = ((idx + 1) / fileQueue.length) * 100;
        document.getElementById('uploadProgressBar').style.width = progress + '%';

      } catch (error) {
        console.error(`Upload error for file ${idx}:`, error);
        item.status = 'error';
        uploadSummary.failed++;
        uploadSummary.errors.push(`${item.file.name}: ${error.message}`);
        
        // Update real-time failed counter
        document.getElementById('realtimeFailed').textContent = uploadSummary.failed;
        
        // Continue to next file instead of stopping
      } finally {
        loading.classList.remove('active');
      }
    }

    async function uploadViaServer(item) {
      const formData = new FormData();
      formData.append('file', item.file);
      formData.append('name', item.mediaName);
      
      // Use individual file folder if set, otherwise use global batch folder
      const folderToUse = item.folder || batchFolderSelect.value;
      if (folderToUse) {
        formData.append('folder', folderToUse);
      }

      let allTags = [];
      if (batchTagsInput.value.trim()) {
        allTags = allTags.concat(
          batchTagsInput.value.trim().split(',').map(t => t.trim()).filter(t => t)
        );
      }
      if (item.tags.trim()) {
        allTags = allTags.concat(
          item.tags.trim().split(',').map(t => t.trim()).filter(t => t)
        );
      }

      if (allTags.length > 0) {
        formData.append('tags', JSON.stringify(allTags));
      }

      const uploadUrl = `${API_BASE_URL}/api/upload`;
      const response = await fetch(uploadUrl, {
        method: 'POST',
        headers: getApiHeaders(),
        body: formData
      });

      if (!response.ok) {
        const contentType = response.headers.get('content-type');
        let errorMessage = `Upload failed (${response.status})`;
        
        try {
          if (contentType && contentType.includes('application/json')) {
            const errorData = await response.json();
            errorMessage = errorData.error || errorMessage;
          } else {
            const errorText = await response.text();
            errorMessage = errorText || errorMessage;
          }
        } catch (e) {
          errorMessage = `Server error (${response.status})`;
        }
        
        throw new Error(errorMessage);
      }

      const responseText = await response.text();
      if (!responseText) {
        throw new Error('Empty response from server');
      }
      
      return JSON.parse(responseText);
    }

    async function uploadDirectToCloudinary(item) {
      try {
        // Use individual file folder if set, otherwise use global batch folder
        const folderToUse = item.folder || batchFolderSelect.value;
        
        // Gather tags from batch and individual levels
        let allTags = [];
        if (batchTagsInput.value.trim()) {
          allTags = allTags.concat(
            batchTagsInput.value.trim().split(',').map(t => t.trim()).filter(t => t)
          );
        }
        if (item.tags.trim()) {
          allTags = allTags.concat(
            item.tags.trim().split(',').map(t => t.trim()).filter(t => t)
          );
        }
        
        const signUrl = `${API_BASE_URL}/api/sign-upload`;
        const signResponse = await fetch(signUrl, {
          method: 'POST',
          headers: getApiHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({
            folder: folderToUse,
            name: item.mediaName,
            isAudio: item.type === 'audio',
            isPDF: item.type === 'pdf',
            tags: allTags.length > 0 ? allTags : undefined
          })
        });

        if (!signResponse.ok) {
          const errText = await signResponse.text();
          throw new Error(`Failed to get upload signature: ${signResponse.status} - ${errText}`);
        }

        const signData = await signResponse.json();
        
        const formData = new FormData();
        formData.append('file', item.file);
        formData.append('api_key', signData.apiKey);
        formData.append('timestamp', signData.timestamp.toString());
        formData.append('signature', signData.signature);
        formData.append('public_id', signData.public_id);
        formData.append('resource_type', signData.resource_type || 'video');
        
        if (signData.context) {
          formData.append('context', signData.context);
        }
        
        if (signData.tags) {
          const tagsArray = typeof signData.tags === 'string' 
            ? signData.tags.split(',') 
            : signData.tags;
          
          // Add batch tags if any
          if (batchTagsInput.value.trim()) {
            const batchTags = batchTagsInput.value.trim().split(',').map(t => t.trim());
            tagsArray.push(...batchTags);
          }
          
          tagsArray.forEach((tag, index) => {
            formData.append(`tags[${index}]`, tag.trim());
          });
        }
        
        if (signData.folder) {
          formData.append('folder', signData.folder);
        }

        const typeEndpoint = signData.resource_type || 'video';
        const uploadUrl = `https://api.cloudinary.com/v1_1/${signData.cloudName}/${typeEndpoint}/upload`;
        
        const uploadResponse = await fetch(uploadUrl, {
          method: 'POST',
          body: formData
        });

        if (!uploadResponse.ok) {
          let errorMessage = `HTTP ${uploadResponse.status}`;
          try {
            const errorData = await uploadResponse.json();
            errorMessage = errorData.error?.message || errorData.message || errorMessage;
          } catch (e) {
            const errorText = await uploadResponse.text();
            errorMessage = errorText || errorMessage;
          }
          throw new Error(`Cloudinary upload failed: ${errorMessage}`);
        }

        const result = await uploadResponse.json();
        return {
          success: true,
          publicId: result.public_id,
          secureUrl: result.secure_url,
          name: item.mediaName,
          tags: result.tags || [item.mediaName],
          metadata: {
            width: result.width,
            height: result.height,
            format: result.format,
            bytes: result.bytes,
            createdAt: result.created_at
          }
        };
      } catch (error) {
        console.error('Direct upload error:', error);
        throw error;
      }
    }

    function showUploadSummary() {
      progressSection.classList.remove('active');
      summarySection.classList.add('active');

      let summaryHtml = `
        <strong>‚úÖ Upload Complete</strong><br><br>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
          <div style="text-align: center; padding: 10px; background: #d4edda; border-radius: 4px;">
            <div style="font-size: 20px; font-weight: bold; color: #28a745;">${uploadSummary.success}</div>
            <div style="font-size: 12px; color: #155724;">Uploaded</div>
          </div>
          <div style="text-align: center; padding: 10px; background: #fff3cd; border-radius: 4px;">
            <div style="font-size: 20px; font-weight: bold; color: #856404;">${uploadSummary.skipped}</div>
            <div style="font-size: 12px; color: #856404;">Skipped</div>
          </div>
          <div style="text-align: center; padding: 10px; background: #f8d7da; border-radius: 4px;">
            <div style="font-size: 20px; font-weight: bold; color: #721c24;">${uploadSummary.failed}</div>
            <div style="font-size: 12px; color: #721c24;">Failed</div>
          </div>
        </div>
        <div style="background: #fef4e7; padding: 12px; border-radius: 6px; border-left: 4px solid #C99A2C; margin-bottom: 15px;">
          <strong style="color: #8B6914;">üé• Videos in this batch:</strong> <span style="font-size: 16px; font-weight: bold; color: #C99A2C;">${uploadSummary.videosUploaded}</span>
        </div>
      `;

      if (uploadSummary.errors.length > 0) {
        summaryHtml += '<strong>Errors:</strong><br>';
        uploadSummary.errors.forEach(err => {
          summaryHtml += `<div style="color: #721c24; font-size: 12px; margin: 5px 0;">‚Ä¢ ${err}</div>`;
        });
      }

      summaryContent.innerHTML = summaryHtml;
    }

    uploadMoreBtn.addEventListener('click', () => {
      summarySection.classList.remove('active');
      uploadSection.classList.add('active');
      fileQueue = [];
      fileInput.value = '';
      resetMessage();
    });

    function showMessage(text, type) {
      message.textContent = text;
      message.className = `message active ${type}`;
    }

    function resetMessage() {
      message.className = 'message';
      message.textContent = '';
    }
  </script>
</body>
</html>
